<!DOCTYPE html>
<html>
<body>

<h1>Fibonacci Calulator (Vanilla)</h1>

<script>

function inputStream(chan) {
    return new Promise(function (resolve, reject) {
        chan.onmessage = function(e) {
//            console.log('received \'' + e.data + '\' from server');
            resolve({data: e.data, chan: {in: inputStream(chan), sock: chan}});  
        }
    });
}
 
function send(obj, chan) {
    let m = JSON.stringify(obj);
//    console.log('Sending to server: ' + m);
    chan.sock.send(m);
    return chan;
}

function receive(chan) {
   return chan.in;
}

function fib(n, c) {
    if (n <= 1) {
        return new Promise(function (resolve, reject) {
            resolve({val: 1, chan: c});
        });
    } else {
        return new Promise(function (resolve, reject) {
            fib(n-1, c).then(function(x) {
                fib(n-2, x.chan).then(function(y) {
                    var c = send({tag: "Add", values: [x.val, y.val]}, y.chan);
                    receive(c).then(function(sum) {
                        resolve({val: JSON.parse(sum.data).values[0], chan: sum.chan});
                    });
                });
            });
        });
    }
}

function open(chan) {
    return new Promise(function (resolve, reject) {
        chan.sock.onopen = function(e) {
//            console.log('Socket open!');
            resolve();
        }
    });
socket.onopen
}

// The program
(async () => {
    var socket = new WebSocket("ws://localhost:9160");
    var init = {in: inputStream(socket), sock: socket};
    await open(init);
    let start = window.performance.now();
    var res = await fib(20, init);
    let end = window.performance.now();
    console.log(end - start);
    console.log(res.val);
})();

</script>

</body>
</html>
